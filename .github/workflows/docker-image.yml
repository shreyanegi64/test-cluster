name: Check YAML Files and Changes

on:
  push:
    branches:
      - main # or your default branch

jobs:
  check_files:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: List YAML files
      id: list_yaml_files
      run: |
        echo "Listing all YAML files..."
        find . -name "*.yaml" -o -name "*.yml" > all_yaml_files.txt
        cat all_yaml_files.txt

    # - name: List changed YAML files in last commit
    #   id: list_changed_files
    #   run: |
    #     echo "Listing changed YAML files in the last commit..."
    #     git diff --name-only HEAD~1 HEAD | grep -E '\.(yaml|yml)$' > changed_yaml_files.txt
    #     if [ -s changed_yaml_files.txt ]; then
    #       echo "Changed YAML files:"
    #       cat changed_yaml_files.txt
    #     else
    #       echo "No YAML files changed in the last commit."
    #     fi

    - name: Check for YAML file changes in the last commit
      id: check_yaml_changes_last_commit
      run: |
        set -e
        
        # Ensure repository has more than one commit
        echo "Checking if repository has more than one commit..."
        commit_count=$(git rev-list --count HEAD)
        
        if [ "$commit_count" -le 1 ]; then
          echo "Only one commit found. Skipping check for changes."
          echo "changed=false" >> $GITHUB_ENV
          exit 0
        fi

        echo "Listing changed YAML files in the last commit..."
        
        # List changed YAML files between the last two commits
        git diff --name-only HEAD~1 HEAD | grep -E '\.(yaml|yml)$' > changed_yaml_files.txt
        
        if [ -s changed_yaml_files.txt ]; then
          echo "Changed YAML files:"
          cat changed_yaml_files.txt
          echo "changed=true" >> $GITHUB_ENV
          echo "files=$(cat changed_yaml_files.txt)" >> $GITHUB_ENV
        else
          echo "No YAML files changed in the last commit."
          echo "changed=false" >> $GITHUB_ENV
        fi
      shell: /usr/bin/bash -e {0}

